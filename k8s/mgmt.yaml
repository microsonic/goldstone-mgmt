apiVersion: v1
kind: ConfigMap
metadata:
    name: onl-platform
data:
    platform: "x86-64-kvm-x86-64-r0"

---

apiVersion: apps/v1
kind: Deployment
metadata:
    name: gs-mgmt
spec:
    replicas: 1
    selector:
        matchLabels:
            app: gs-mgmt
    strategy:
        type: Recreate
    template:
        metadata:
            labels:
                app: gs-mgmt
        spec:
            shareProcessNamespace: true
            initContainers:
            - name: prep-sysrepo
              image: docker.io/microsonic/gs-mgmt-debug:latest
              imagePullPolicy: IfNotPresent
              command: ['sysrepoctl', '-s', '/var/lib/goldstone/yang/gs', '--install', '/var/lib/goldstone/yang/gs/goldstone-tai.yang,/var/lib/goldstone/yang/gs/goldstone-onlp.yang']
              volumeMounts:
              - name: shm
                mountPath: /dev/shm
              - name: sysrepo
                mountPath: /var/lib/sysrepo
            containers:
            - name: cli
              image: docker.io/microsonic/gs-mgmt-debug:latest
              imagePullPolicy: IfNotPresent
              command: ['sh', '-c', 'sleep 15 && gscli -c "transponder; show"']
              volumeMounts:
              - name: shm
                mountPath: /dev/shm
              - name: sysrepo
                mountPath: /var/lib/sysrepo
            - name: tai
              image: docker.io/microsonic/gs-mgmt-debug:latest
              imagePullPolicy: IfNotPresent
              command: ['sh', '-c', 'sleep 10 && gssouthd-tai -v']
              volumeMounts:
              - name: shm
                mountPath: /dev/shm
              - name: sysrepo
                mountPath: /var/lib/sysrepo
            - name: onlp
              image: docker.io/microsonic/gs-mgmt-debug:latest
              imagePullPolicy: IfNotPresent
              command: ['sh', '-c', 'ln -sf /lib/platform-config/x86-64-kvm-x86-64-r0/onl/lib/libonlp-x86-64-kvm-x86-64.so /lib/x86_64-linux-gnu/libonlp-platform.so.1 && gssouthd-onlp']
              volumeMounts:
              - name: shm
                mountPath: /dev/shm
              - name: sysrepo
                mountPath: /var/lib/sysrepo
              - name: onl-platform
                mountPath: /etc/onl/
              securityContext:
                capabilities:
                  add:
                  - IPC_OWNER
                  - IPC_LOCK
            - name: taish-server
              image: docker.io/microsonic/tai:latest
              imagePullPolicy: IfNotPresent
              command: ['taish_server']
            volumes:
            - name: shm
              emptyDir:
                  medium: Memory
            - name: sysrepo
              emptyDir: {}
            - name: onl-platform
              configMap:
                name: onl-platform
